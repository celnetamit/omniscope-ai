name: Scheduled Tasks

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # Database Backup
  database-backup:
    name: Database Backup
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
    
    - name: Create database backup
      run: |
        export KUBECONFIG=kubeconfig
        BACKUP_FILE="omniscope-backup-$(date +%Y%m%d-%H%M%S).sql"
        kubectl exec -n omniscope statefulset/postgres -- \
          pg_dump -U omniscope_user omniscope > $BACKUP_FILE
        gzip $BACKUP_FILE
    
    - name: Upload to S3
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Sync to S3
      run: |
        aws s3 cp omniscope-backup-*.sql.gz s3://omniscope-backups/database/
    
    - name: Clean old backups
      run: |
        # Keep last 30 days of backups
        aws s3 ls s3://omniscope-backups/database/ | \
          awk '{print $4}' | \
          sort -r | \
          tail -n +31 | \
          xargs -I {} aws s3 rm s3://omniscope-backups/database/{}
    
    - name: Notify on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'Database backup failed'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-results.json'
    
    - name: Check for critical vulnerabilities
      run: |
        CRITICAL=$(jq '.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL") | .VulnerabilityID' trivy-results.json | wc -l)
        if [ $CRITICAL -gt 0 ]; then
          echo "Found $CRITICAL critical vulnerabilities"
          exit 1
        fi
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-results
        path: trivy-results.json
    
    - name: Notify on critical vulnerabilities
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'Critical security vulnerabilities found'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Performance Testing
  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Locust
      run: pip install locust
    
    - name: Run load test
      run: |
        locust -f tests/load_test.py \
          --host https://api.omniscope.ai \
          --users 100 \
          --spawn-rate 10 \
          --run-time 5m \
          --headless \
          --html performance-report.html
    
    - name: Upload performance report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance-report.html
    
    - name: Check performance thresholds
      run: |
        # Parse results and check against thresholds
        # Fail if p95 > 2s or error rate > 1%
        python tests/check_performance.py performance-report.html

  # Cleanup Old Resources
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
    
    - name: Clean old completed jobs
      run: |
        export KUBECONFIG=kubeconfig
        kubectl delete jobs -n omniscope --field-selector status.successful=1
    
    - name: Clean old pods
      run: |
        export KUBECONFIG=kubeconfig
        kubectl delete pods -n omniscope --field-selector status.phase=Succeeded
        kubectl delete pods -n omniscope --field-selector status.phase=Failed
    
    - name: Clean old images
      run: |
        # Delete images older than 30 days
        gh api \
          -H "Accept: application/vnd.github+json" \
          /orgs/omniscope/packages/container/${{ github.event.repository.name }}/versions \
          | jq -r '.[] | select(.created_at < (now - 2592000 | strftime("%Y-%m-%dT%H:%M:%SZ"))) | .id' \
          | xargs -I {} gh api --method DELETE \
            -H "Accept: application/vnd.github+json" \
            /orgs/omniscope/packages/container/${{ github.event.repository.name }}/versions/{}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Health Check
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Check production health
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api.omniscope.ai/health)
        if [ $response -ne 200 ]; then
          echo "Health check failed with status $response"
          exit 1
        fi
    
    - name: Check staging health
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://staging-api.omniscope.ai/health)
        if [ $response -ne 200 ]; then
          echo "Staging health check failed with status $response"
          exit 1
        fi
    
    - name: Notify on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'Health check failed'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
